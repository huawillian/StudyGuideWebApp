<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/polymer-quill/polymer-quill.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<!-- custom elements here -->
<link rel="import" href="./section-view.html">

<dom-module id="StudyGuideWebApp-app">
  <template>
    <style>
      :host {
        display: block;
      }

      .dark-primary-color    { background: #455A64; }
      .default-primary-color { background: #607D8B; }
      .light-primary-color   { background: #CFD8DC; }
      .text-primary-color    { color: #FFFFFF; }
      .accent-color          { background: #536DFE; }
      .primary-text-color    { color: #212121; }
      .secondary-text-color  { color: #757575; }
      .divider-color         { border-color: #BDBDBD; }

      paper-item {
        margin: 0;
        padding: 5%;
        width: 90%;
        height: 50px;
        font-size: 20px;
      }

      #menu-header {
        height: 70px;
        font-size: 50px;
        margin: 0;
        padding: 5%;
        width: 90%;
        margin-top: 30px;
      }

      #menu {
        min-height:100vh;
        height: 100%;
      }

      paper-header-panel { 
        height: 100%;
      }

      paper-drawer-panel{
        overflow: scroll;
      }

      paper-toolbar {
        color: white;
      }

      #add {
        margin-right: 10px;
      }

      #remove {
        margin-right: 10px;
      }

      paper-item:hover{
        background-color: rgba(0,0,0,0.1);
        cursor:pointer;
      }

      paper-dialog {
        width:75%;
        min-width: 300px;
        height: 75%;
        min-height: 300px;
      }

      iron-selector > paper-item {
        padding-top: 5px;
        padding-bottom: 5px
      }

      iron-selector > paper-item:hover {
        background-color: #536DFE;
      }

      .iron-selected {
        background-color: #536DFE;
      }
    </style>

    <firebase-app auth-domain="studyguidemvp.firebaseapp.com"
      database-url="https://studyguidemvp.firebaseio.com/"
      api-key="AIzaSyCriXr4uO-J76FyNxQlX_pPdO9wLjbzomo">
    </firebase-app>

    <firebase-document id='doc'
      path="/guides"
      data="{{noteData}}">
    </firebase-document>


    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page/:section"
        data="{{routeData}}"
        tail="{{tail}}">
    </app-route>

    <paper-dialog id='cardDialog' modal>
      <h1>Create New Card</h1>
      <paper-input always-float-label label="Title" value={{cardTitle}}></paper-input>
      <paper-input always-float-label label="Description" value={{cardDescription}}></paper-input>

      <div class="buttons" style="margin-top:30px">
        <paper-button dialog-dismiss> Cancel</paper-button>
        <paper-button dialog-confirm autofocus id='createCardButton'> Create</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id='removeDialog' modal>
      <h1>Remove Cards</h1>
      <paper-dialog-scrollable>
        <iron-selector multi id='multiRemove'>
          <template is="dom-repeat" items="{{sections}}">
              <paper-item> {{item.sectionname}} </paper-item>
          </template>
        </iron-selector>
      </paper-dialog-scrollable>

      <div class="buttons" style="margin-top:30px">
        <paper-button dialog-dismiss> Cancel</paper-button>
        <paper-button dialog-confirm autofocus id='removeCardButton'> Remove </paper-button>
      </div>
    </paper-dialog>

    <paper-drawer-panel id='drawer'>

      <paper-header-panel drawer id='menu'>
        <div>
          <h1 id="menu-header"> Cards </h1>
          <hr>
          <template is="dom-repeat" items="{{sections}}">
              <paper-item> {{item.sectionname}} </paper-item>
          </template>
          <hr>
          <paper-item> <iron-icon id='add' icon="add"></iron-icon> New Card </paper-item>
          <paper-item> <iron-icon id='remove' icon="remove"></iron-icon> Remove Card </paper-item>
        </div>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar class="dark-primary-color text-primary-color ">
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <h3> {{title}} </h3>
        </paper-toolbar>


        <!-- iron-pages selects the view based on the active route -->
        <iron-pages selected="[[routeData.page]]" attr-for-selected="name" fallback-selection="invalidPage">
          <div name='content'> <section-view data={{sectionData}}> </section-view> </div>
        </iron-pages>

      </paper-header-panel>

    </paper-drawer-panel>



  </template>

  <script>
    Polymer({

      is: 'StudyGuideWebApp-app',

      properties: {
        noteData: {
          type: String,
          value: '',
          observer: 'onNoteDataChange'
        },
        sections: {
          type: Array,
          value: []
        },
        guide: {
          type: String,
          value: 'Example Guide'
        },
        title: String,
        sectionData: Object
      },

      ready: function(){
        this.listen(this.$.menu, 'click', 'setSectionPage');
        this.listen(this.$.createCardButton, 'click', 'createCardHandler');
        this.listen(this.$.removeCardButton, 'click', 'removeCardHandler');
      },

      listeners: {
          'saveToDatabase': 'handleSaveToDatabase',
      },

      onNoteDataChange: function(newVal){
        console.log(newVal);
        if(!Array.isArray(newVal) || newVal === undefined) return;

        this.set('pageData', newVal.find((obj) => obj.guidename == this.guide));
        this.set('sections', this.pageData.sections);
        this.set('sectionData', this.sections.find((obj) => obj.sectionname == this.routeData.section));
        this.set('title', this.pageData.guidename);

        console.log(this.pageData, this.sections, this.routeData);
      },

      setSectionPage: function(e){
        console.log(e.target.innerText, this.route);
        console.log(e.target.innerText);

        if(e.target.innerText == 'Cards') return;
        if(e.target.innerText.includes('New Card')) {
          this.$.cardDialog.open();
          return;
        };
        if(e.target.innerText.includes('Remove Card')) {
          this.$.removeDialog.open();
          return;
        };

        this.set('route.path', '/content/' + e.target.innerText);
        this.set('sectionData', this.sections.find((obj) => obj.sectionname == e.target.innerText));
        this.$.drawer.closeDrawer();
      },

      handleSaveToDatabase: function(data){
        console.log(data.detail);
        this.sectionData.content = data.detail.content;
        console.log(this.noteData);
        this.$.doc.data = $.extend(true, {}, this.noteData);
      },

      createCardHandler: function(){
        console.log(this.cardTitle, this.cardDescription);
        this.sections.push({sectionname: this.cardTitle, description: this.cardDescription, content: 'Edit me!'});
        this.set('sections', this.sections);
        this.$.doc.data = $.extend(true, {}, this.noteData);
        this.set('route.path', '/content/' + this.cardTitle);
        this.$.doc.path = '';
        this.$.doc.path = '/guides';
        this.$.drawer.closeDrawer();
      },

      removeCardHandler: function() {
        var removeArr = this.$.multiRemove.selectedValues;
        removeArr = removeArr.sort(function(a,b) { return b - a});
        console.log(removeArr);
        removeArr.forEach(idx => this.sections.splice(idx, 1));
        this.set('sections', this.sections);
        this.$.doc.data = $.extend(true, {}, this.noteData);
        this.set('route.path', '/content/' + this.cardTitle);
        this.$.doc.path = '';
        this.$.doc.path = '/guides';
        this.$.drawer.closeDrawer();
      }


    });
  </script>
</dom-module>
